{% extends 'base.html' %}

{% block title %}Profile{% endblock %}

{% block content %}
<div class="profile-layout">
	<div class="profile form-container user-layout">
		<div>
			<h3>Your Profile</h3>
			<p><i class="fas fa-user-circle"></i></p>
			<p class="email">{{request.user.email}}</p>
		</div>

		<div class="detail">
			<p>{{request.user.first_name}}</p>
			<p>{{request.user.last_name}}</p>
			<p><i class="far fa-calendar-check"></i> {{request.user.date_joined}}</p>
		</div>
		<div><a href="{% url 'edit_profile' %}" class="btn">Edit</a></div>
	</div>
	<div class="my-poll">
		<h3>Your Polls</h3>
		{% if polls %}
			{% for poll in polls %}
				<div class="poll-container poll-container-expand" data-poll-id="{{poll.id}}">
					<p class="user-info">
						<span>{{poll.user.first_name}} &middot; {{ poll.date }}</span>
						<i class="far fa-trash-alt delete"></i>
					</p>
				    <p class="poll-subject">{{poll.question}}</p>
				    <p class="all-votes">{{ poll.get_total_vote }} votes</p>
		
					{% for option in poll.polloption_set.all %}
						<div class="radio-input check">
							<div class="label">
								<span class="result voted-result" style="width:{{option.get_percentage}}%"></span>
								<span class="option">{{ option.option }}</span>
								<span class="percentage">{{option.get_percentage}}%</span>
							</div>
						</div>
					{% endfor %}
					{% if poll.close %}
					<p>
	                	<a class="vote-now close-poll closed">CLOSED</a>
	                </p>
	                {% else %}
					<p>
	                	<a class="vote-now close-poll">CLOSE</a>
	                </p>
	                {% endif %}
				</div>

			{% endfor %}
			{% else %}
			<div class="no-poll">
				<p>You have no polls, <a href="{% url 'create_poll' %}">let's make one &#x2192;</a></p>
			</div>
		{% endif %}
	</div>
</div>

	<script type="text/javascript">
		let close = $(".close-poll")

		close.click(function(e) {
			$(this).html("CLOSED").addClass("closed")
			let questionId = $(this).parents(".poll-container").data("poll-id")
			console.log(questionId)
			$.ajax({
			    type:"put",
			    url: `/api/poll-question/${questionId}/`,
			    dataType:'json',
			    headers: {
					'Content-type': 'application/json',
					'X-CSRFToken': csrftoken,
					'Accept': 'application/json; indent=4',
				},
			    data: JSON.stringify({close: true}),
			    success: function(response) {
			        console.log(response);
			    }
			})
		})

		let del = $(".delete")
		del.click(function(e) {
			let poll = $(this).closest(".poll-container")
			poll.fadeOut(500)
			let questionId = $(this).parents(".poll-container").data("poll-id")
			$.ajax({
			    type:"delete",
			    url: `/api/poll-question/${questionId}/`,
			    dataType:'json',
			    headers: {
					'Content-type': 'application/json',
					'X-CSRFToken': csrftoken,
					'Accept': 'application/json; indent=4',
				},
			    success: function(response) {
			        console.log(response);
			    }
			})
		})

		function getCookie(name) {
		    let cookieValue = null;
		    if (document.cookie && document.cookie !== '') {
		        const cookies = document.cookie.split(';');
		        for (let i = 0; i < cookies.length; i++) {
		            const cookie = cookies[i].trim();
		            // Does this cookie string begin with the name we want?
		            if (cookie.substring(0, name.length + 1) === (name + '=')) {
		                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
		                break;
		            }
		        }
		    }
		    return cookieValue;
		}
		const csrftoken = getCookie('csrftoken');
	</script>
{% endblock content %}